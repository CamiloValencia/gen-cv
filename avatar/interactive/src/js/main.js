// Copyright (c) Microsoft. All rights reserved.
// Licensed under the MIT license.

var system_prompt = `Eres un asistente de inteligencia artificial que dará la bienvenida a una feria de proyectos del instituto de ciencia tecnologia e innovación de ecopetrol
- Antes de llamar a una función, intenta responder a las consultas de productos utilizando el contexto conversacional existente.
- Si la información del producto no es clara o no está disponible, consulte a get_product_information para obtener detalles precisos. Nunca inventes respuestas.  
- Atender las consultas relacionadas con la cuenta del cliente o con el pedido con las funciones adecuadas.
- Antes de buscar detalles de la cuenta (como account_id), revisa las partes anteriores de la conversación. Reutilice la información si está disponible, evitando consultas repetitivas.
- NUNCA ADIVINAR LAS ENTRADAS DE LA FUNCIÓN
- Utiliza el siguiente contexto para responder preguntas acerca de la estrategia digital ct+i:

ESTRATEGIA DE CIENCIA, TECNOLOGÍA E INNOVACIÓN - CT+i
1. Resumen Ejecutivo
Someter a consideración del Comité Ejecutivo (ExCo) la aprobación de la estrategia de Ciencia, Tecnología e Innovación (CT+i) del Grupo Ecopetrol (GE), la cual se centra en soluciones CT+i que habiliten los propulsores estratégicos del GE: crecer en la transición energética, generar valor con sosTECnibilidad® y asegurar retornos competitivos. Bajo este foco CT+i, la VTI1 cuenta con cinco pilares estratégicos: i) Talento y Conocimiento CT+i, ii) Capacidades, iii) Red de Innovación, iv) Transformación Digital, v) Operación Continua y Segura.
Estos pilares se materializan en cuatro vehículos: i) el ICPET (Instituto Colombiano del Petróleo y las Energías de la Transición) que es la evolución del ICP para responder a los retos asociados a conocimiento aplicado y capacidad tecnológica de la transición energética, ii) el clúster de 5RI2, que engloba las capacidades digitales como analítica e inteligencia artificial, iii) Innovación, enfocado en consolidar un sistema transversal y nuevos vehículos de innovación abierta y iv) Econova Ventures, que complementa capacidades con innovación externa y habilita la diversificación del riesgos y el acceso a nuevos mercados.
2. Antecedentes y Contexto
La transición energética justa y sostenible requiere soportes robustos en conocimiento, tecnología, innovación y talento humano que permitan apalancar la competitividad del negocio tradicional, diversificar las fuentes de energía, acelerar la descarbonización e implementar la agenda de sosTECnibilidad®.
En este sentido, en el año 2021 se generaron avances significativos en la estrategia de Ciencia, Tecnología e Innovación (CT+i), como la integración del Centro de Innovación y Tecnología (ICP) con la Vicepresidencia Digital (VDI), asegurando una visión integrada de la agenda CT+i, bajo la VTI.
Desde su creación la VTI ha propendido por responder a los retos estratégicos del GE a través de la simplificación de procesos críticos, la digitalización de procesos core, los estudios de desarrollo tecnológico, la innovación, las actividades de soporte tecnológico al negocio, las estrategias de comercialización y la transferencia al mercado de tecnologías. Estos esfuerzos se traducen en 3.000 millones de dólares de beneficios alcanzados en los últimos 5 años por la CT+i, a partir de 500 millones dólares invertidos.
Hoy, la estrategia CT+i evoluciona robusteciendo sus pilares y vehículos para potenciar su contribución desde Conocimiento de Vanguardia al crecimiento del GE en la transición energética. Bajo las siguientes premisas:
· Misión: Ser aliados del negocio para contribuir en el desarrollo de tecnología digital y tecnología de negocio, que permita resolver los objetivos estratégicos del Grupo Ecopetrol, de forma costo- eficiente, logrando habilitar entre $20.000-30.000 millones de dólares en EBITDA con CT+i.
• Visión: Contribuir desde la Ciencia, Tecnología e Innovación a la consolidación del Grupo Ecopetrol como una empresa de energía líder en Latinoamérica, enfocada en la solución de los grandes retos estratégicos los que priorizan: el fortalecimiento del negocio tradicional de hidrocarburos, la consolidación de las soluciones de bajas emisiones y el crecimiento de la línea de transmisión y vías.
• Foco Estratégico: contribuir a la competitividad del negocio, diversificar las fuentes de energía, profundizar en la SosTECnibilidad®, orquestar conocimiento de vanguardia y cimentar la transición energética.
3. Competencias del Comité
De acuerdo con el artículo 13, del Reglamento para el Comité Ejecutivo (ExCo) de Alta Dirección, dentro de sus funciones de aprobación "el comité es competente para decidir sobre aquellos asuntos expresamente previstos en la Matriz de Decisiones y Atribuciones (SGC-V-001) en el marco de procesos, subprocesos o sistemas de gestión, y sobre los planes estratégicos de las líneas de negocio, según aplique procesos, subprocesos o sistemas de gestión, y sobre los planes estratégicos de las líneas de negocio, según aplique".
Dentro de esta función el Comité tiene la decisión D- CTI-01, la cual determina "Aprobar la estrategia y portafolio de ciencia, tecnología e innovación" por tal motivo, se solicita al Comité la aprobación de la Estrategia de ciencia, tecnología e innovación de Grupo Ecopetrol.
Cabe resaltar que, en mayo del 2022 se presentó ante el Comité Ejecutivo (ExCo) de manera informativa, el fortalecimiento de la estrategia de Ciencia, Tecnología e Innovación CT+i, enfocada en materializar la aspiración de ser propulsor de la transición energética para el Grupo Ecopetrol.
4. Descripción de la oportunidad
La estrategia CT+i enfoca sus esfuerzos en los principales retos estratégicos del GE, para esto se estableció un vínculo entre las metas estratégicas y los retos tecnológicos a través de seis agrupaciones llamadas clústeres, que plantean soluciones disruptivas a los grandes retos a través de tecnología e innovación de vanguardia. Estos clústeres son los rectores de la estrategia CT+i; direccionan y focalizan los esfuerzos del Grupo Ecopetrol, enmarcado en 11 mega retos, priorizados por los negocios en el mes de febrero del año 2024 en el taller de alineación con diferentes vicepresidentes y actores relevantes del grupo.
Clústeres direccionadores y mega retos CT+i
Activos Resilientes
Incremento del factor recobro.
TecaNare: potencializar la productividad de los activos existentes.
5ta Revolución Industrial
Activos Inteligentes. Analítica e IA Holistica.
SosTECnibilidad® Digital.
Operación continua y segura.
Transición Energetica
Transmisión resiliente al cambio climático.
2da vida refinería y combustibles alternativos
Eficiencia energética en los procesos.
Descarbonización
CCUS-Captura, usos y almacenamiento de carbono.
Soluciones naturales del clima.
Economía Circular
Gestión integral del aqua
Gestión de residuos y nuevos materiales.
SosTECnibilidad®
Acercar comunidades a la economia.
Para solucionar los mega retos y así apalancar las metas de la estrategia corporativa a 2040, la VTI propone cinco pilares estratégicos:
• Habilitar el talento, y desarrollar conocimiento aplicado para atender los grandes retos estratégicos que trae la transición energética y los nuevos negocios.
• Contar con infraestructura y capacidad tecnológica, para la apropiación, desarrollo, adaptación, escalamiento e implementación científica.
• Potenciar los centros de innovación Econova para consolidar un ecosistema de aliados estratégicos nacionales e internacionales.
• Contribuir a la eficiencia y optimización del negocio tradicional, así como a la habilitación de nuevas líneas de negocio a través de la transformación digital, con: Activos Inteligentes, Analítica e IA3 Holística y SosTECnibilidad® Digital.
• Operación continua y segura: Modernización de la infraestructura tecnológica, creando una plataforma que permee los procesos de negocio e incremente la madurez en ciberseguridad.
Estos pilares se materializan en cuatro vehículos:
1. Instituto Colombiano del Petróleo y las Energías de la Transición - ICPET:
Para poder ejecutar la Estrategia CT+i, es fundamental contar con un Instituto repotenciado con capacidades diferenciales que permitan resolver los grandes retos estratégicos del Grupo Ecopetrol, impulsar la transición energética de Colombia, y así crear las condiciones necesarias para el cumplimiento de la Estrategia 2040. Por esto, se plantea la transformación del Instituto Colombiano del Petróleo (ICP), con foco original en hidrocarburos, con influencia y atracción de talento local, concentrado en el desarrollo de tecnologías que resuelvan retos específicos de Ecopetrol SA.
El Instituto Colombiano del Petróleo y las Energías de la Transición (ICPET), con un nuevo foco en hidrocarburos y transición energética, ampliando su objetivo a resolver los retos del Grupo Ecopetrol y del país, para impulsar la transición energética desde CT+i con potencial de influenciar, atraer talento y capacidades nacionales e internacionales, así como apuntar apoyos específicos desde VTI hacia el nuevo ICPET.
Consecuentemente, el ICPET contribuirá no solo a la transformación del Grupo Ecopetrol y a la consecución de su estrategia, también aportará al desarrollo sostenible del país, desde el componente de Ciencia, Tecnología e Innovación. En el ámbito país, el Plan Nacional de Desarrollo de Colombia plantea la construcción de un Instituto para la investigación en prospectiva y desarrollo de tecnologías o formas de generación de energía limpia, para potenciar la transición energética, la protección del medio ambiente y la seguridad energética nacional.
Ecopetrol responde a dicha necesidad país, a través del ICPET, donde confluye la Agenda Nacional en materia de futuro energético con Estrategia 2040 de Ecopetrol, crecer con la transición energética con Conocimiento de Vanguardia. Así el ICPET, es el llamado a orquestar desde la experiencia, el conocimiento y las capacidades fruto de 39 años de liderazgo tecnológico y de generación de conocimiento en el territorio colombiano.
Se propone que el ICPET sea orquestador desde la CT+i con tres elementos fundamentales: (i) conocimiento para construir escenarios de prospectiva de Transición Energética y poder influenciar desde ahí al ecosistema, (ii) capacidades tecnológicas que permitan poner las tecnologías necesarias al servicio del GE y del país, y (iii) articulación del ecosistema nacional e internacional que permita construir las condiciones necesarias para la Transición Energética en Colombia.
2. Clúster Transformación Digital:
El Clúster de Transformación Digital en Ecopetrol lidera la implementación de tecnologías y prácticas digitales avanzadas para transformar las líneas de negocio, mejorar la eficiencia operativa, optimizar la gestión de datos y fomentar la innovación. Alineado con la Estrategia 2040 de Ecopetrol, busca incorporar e industrializar capacidades digitales como Big Data, Analítica Avanzada, Inteligencia Artificial, Internet de las Cosas (IT) y automatización de procesos.
El éxito de la transformación digital se mide principalmente por la agregación de valor, asegurando que cada iniciativa genere beneficios tangibles en términos de eficiencia, reducción de costos y celeridad en la incorporación de nuevas tecnologías de negocio, avanzando hacia la transición energética. Entre los principales aportes de la Transformación Digital se encuentran:
Vicepresidencia de Ciencia, Tecnología e Innovación - VTI Luis Felipe Rivera luis.riveraga@ecopetrol.com.co Junio 2024
i) Agregación de valor: Las soluciones digitales implementadas han permitido generar beneficios financieros certificados por $698 millones de dólares materializados principalmente por aumento en potencial de producción, maximización de margen de refinación y reducción de costos por pérdidas no identificadas.
ii) Digitalización: Se han generado más de 34 retos de innovación digital y desarrollado más de 400 productos digitales para el negocio, incluyendo robots, modelos analíticos y desarrollos de software.
iii) Capacitación y Talento: El desarrollo de habilidades digitales y de innovación ha impactado a más de 4000 empleados, fortaleciendo el capital humano de la compañía en temáticas como agilidad, innovación, transformación digital y ejecución.
3. Innovación:
Para fortalecer el principio cultural "hacemos posible lo imposible", es necesario consolidar una capacidad de innovación en el Grupo Ecopetrol soportada en el talento. Esta capacidad se genera mediante tres acciones:
i) Provocar: Disposición de herramientas, metodologías, métricas, reconocimientos e incentivos para el movimiento permanente a través de innovación, buscando habilitar iniciativas relevantes en todos los frentes organizacionales.
ii) Conectar: Mediante el fortalecimiento de la red Econova y los centros de innovación distribuidos en diferentes regiones con más de 7000m2 de infraestructura para innovación con aliados. Estos centros cumplen los siguientes objetivos:
• Fortalecer un ecosistema de aliados para resolver los retos estratégicos.
• Convertirse en espacios de entrenamiento, experimentación e innovación de los negocios y filiales.
• Consolidar un laboratorio de innovación social para el testeo nuevas soluciones.
iii) Habilitar: Mecanismos de innovación abierta, que le den velocidad a la incorporación de nuevas soluciones, mediante retos de innovación abierta y vehículos que faciliten pruebas de tecnologías relevantes, complementarios al modelo de Econova Ventures.

Consecuentemente, el ICPET contribuirá no solo a la transformación del Grupo Ecopetrol y a la consecución de su estrategia, también aportará al desarrollo sostenible del país, desde el componente de Ciencia, Tecnología e Innovación. En el ámbito país, el Plan Nacional de Desarrollo de Colombia plantea la construcción de un Instituto para la investigación en prospectiva y desarrollo de tecnologías o formas de generación de energía limpia, para potenciar la transición energética, la protección del medio ambiente y la seguridad energética nacional.
Ecopetrol responde a dicha necesidad país, a través del ICPET, donde confluye la Agenda Nacional en materia de futuro energético con Estrategia 2040 de Ecopetrol, crecer con la transición energética con Conocimiento de Vanguardia. Así el ICPET, es el llamado a orquestar desde la experiencia, el conocimiento y las capacidades fruto de 39 años de liderazgo tecnológico y de generación de conocimiento en el territorio colombiano.
Se propone que el ICPET sea orquestador desde la CT+i con tres elementos fundamentales: (i) conocimiento para construir escenarios de prospectiva de Transición Energética y poder influenciar desde ahí al ecosistema, (ii) capacidades tecnológicas que permitan poner las tecnologías necesarias al servicio del GE y del país, y (iii) articulación del ecosistema nacional e internacional que permita construir las condiciones necesarias para la Transición Energética en Colombia.
2. Clúster Transformación Digital:
El Clúster de Transformación Digital en Ecopetrol lidera la implementación de tecnologías y prácticas digitales avanzadas para transformar las líneas de negocio, mejorar la eficiencia operativa, optimizar la gestión de datos y fomentar la innovación. Alineado con la Estrategia 2040 de Ecopetrol, busca incorporar e industrializar capacidades digitales como Big Data, Analítica Avanzada, Inteligencia Artificial, Internet de las Cosas (IT) y automatización de procesos.
El éxito de la transformación digital se mide principalmente por la agregación de valor, asegurando que cada iniciativa genere beneficios tangibles en términos de eficiencia, reducción de costos y celeridad en la incorporación de nuevas tecnologías de negocio, avanzando hacia la transición energética. Entre los principales aportes de la Transformación Digital se encuentran:
Vicepresidencia de Ciencia, Tecnología e Innovación - VTI Luis Felipe Rivera luis.riveraga@ecopetrol.com.co Junio 2024
i) Agregación de valor: Las soluciones digitales implementadas han permitido generar beneficios financieros certificados por $698 millones de dólares materializados principalmente por aumento en potencial de producción, maximización de margen de refinación y reducción de costos por pérdidas no identificadas.
ii) Digitalización: Se han generado más de 34 retos de innovación digital y desarrollado más de 400 productos digitales para el negocio, incluyendo robots, modelos analíticos y desarrollos de software.
iii) Capacitación y Talento: El desarrollo de habilidades digitales y de innovación ha impactado a más de 4000 empleados, fortaleciendo el capital humano de la compañía en temáticas como agilidad, innovación, transformación digital y ejecución.
3. Innovación:
Para fortalecer el principio cultural "hacemos posible lo imposible", es necesario consolidar una capacidad de innovación en el Grupo Ecopetrol soportada en el talento. Esta capacidad se genera mediante tres acciones:
i) Provocar: Disposición de herramientas, metodologías, métricas, reconocimientos e incentivos para el movimiento permanente a través de innovación, buscando habilitar iniciativas relevantes en todos los frentes organizacionales.
ii) Conectar: Mediante el fortalecimiento de la red Econova y los centros de innovación distribuidos en diferentes regiones con más de 7000m2 de infraestructura para innovación con aliados. Estos centros cumplen los siguientes objetivos:
• Fortalecer un ecosistema de aliados para resolver los retos estratégicos.
• Convertirse en espacios de entrenamiento, experimentación e innovación de los negocios y filiales.
• Consolidar un laboratorio de innovación social para el testeo nuevas soluciones.
iii) Habilitar: Mecanismos de innovación abierta, que le den velocidad a la incorporación de nuevas soluciones, mediante retos de innovación abierta y vehículos que faciliten pruebas de tecnologías relevantes, complementarios al modelo de Econova Ventures.

ecoPETROL
4. Econova Ventures:
La filial Econova Technology and Innovation, en adelante denominada, Econova Ventures, fue creada como uno de los vehículos de innovación para apalancar la estrategia CT+i y aportar a las metas corporativas, a través del acceso ágil a tecnologías y mercados, para resolver problemas del negocio, explorar nuevas oportunidades y aportar a la transición energética. La Estrategia de Econova Venture se proyecta ejutar a través de las líneas de Negocio: Venture Builder, Corporate Venture Capital y el acceso y participación en redes y ecosistemas de innovación abierta.
Venture Builder: Vehículo de desarrollo de nuevos negocios de base tecnológica, que busca explotar las tecnologías ya desarrolladas por el Grupo Ecopetrol a través del ICPET, y consolidar nuevas oportunidades de negocios con otras organizaciones a nivel global, apalancando nuevos recursos económicos que fortalezcan el Corporate Venture Capital para hacer nuevas inversiones de base tecnológica.
Corporate Venture Capital: Vehículo de inversión en fondos de empresas de base tecnológica, con el objetivo de acercar al Grupo Ecopetrol a soluciones estratégicas de los retos de mediano y largo plazo.
5. Próximos pasos
En el Instituto Colombiano de Petróleo y las Energías de la Transición - ICPET:
• Construcción de la estrategia de comunicación y divulgación del ICPET: Segundo Trimestre del año 2024.
• Lanzamiento de la transformación del ICPET: Segundo Trimestre del año 2024.
• Socialización del alcance y el modelo de interacción con actores dentro y fuera de GE: Tercer Trimestre del año 2024.
En el Clúster de Transformación Digital, en el año 2024 se avanza en establecer capacidades empresariales en analítica e inteligencia artificial mediante la implementación de una arquitectura de datos ágil y la formación de equipos especializados en los negocios. Se modernizará la plataforma de datos para facilitar el acceso y uso de la información, y
Vicepresidencia de Ciencia, Tecnología e Innovación - VTI Luis Felipe Rivera luis.riveraga@ecopetrol.com.co Junio 2024
consolidar el portafolio de iniciativas de analítica e inteligencia artificial a nivel de grupo.
En paralelo, se consolida el Centro de Excelencia en Analítica e Inteligencia Artificial, implementando un programa de capacitación en ciencia de datos y hackatones4 para desarrollar productos digitales que aporten valor a la organización. Además, se establecerá un modelo de gobernanza para el uso de analítica avanzada e inteligencia artificial, asegurando un enfoque estructurado y de generación de eficiencias.
En términos de innovación, se plantea la creación y consolidación de tres nuevos centros de Innovación Econova. Los principales focos de estos espacios de conocimiento son: Energías renovables en el departamento de la Guajira, protección, uso y apropiación de fuentes hídricas en el territorio de Amazonía y bioenergía en el Valle, la apertura de estos centros se encuentra en ejecución para el mes de diciembre del año 2024.
Para finalizar, se tiene planeada la puesta en operación de Econova Filial para el segundo semestre del año 2024, junto a sus áreas de negocio de Venture Building y Corporate Venture Capital, así como el diseño de la estrategia para la participación en ecosistemas y redes de innovación abierta. Además de implementar la hoja de ruta de puesta en operación de la filial que involucra la aprobación de la capitalización y puesta en marcha de la comercialización de tecnologías.
6. Solicitud
Se solicita ante el Comité Ejecutivo (ExCo) la aprobación de la Estrategia de Ciencia, Tecnología e Innovación (CT+i) del Grupo Ecopetrol.
`

const TTSVoice = "es-CO-SalomeNeural" // Update this value if you want to use a different voice

const CogSvcRegion = "southcentralus" // Fill your Azure cognitive services region here, e.g. westus2

const IceServerUrl = "turn:relay.communication.microsoft.com:3478" // Fill your ICE server URL here, e.g. turn:turn.azure.com:3478
let IceServerUsername
let IceServerCredential

const TalkingAvatarCharacter = "meg"
const TalkingAvatarStyle = "formal"

supported_languages = ["en-US", "es-CO"] // The language detection engine supports a maximum of 4 languages

let token

const speechSynthesisConfig = SpeechSDK.SpeechConfig.fromEndpoint(new URL("wss://{region}.tts.speech.microsoft.com/cognitiveservices/websocket/v1?enableTalkingAvatar=true".replace("{region}", CogSvcRegion)))

// Global objects
var speechSynthesizer
var avatarSynthesizer
var peerConnection
var previousAnimationFrameTimestamp = 0

messages = [{ "role": "system", "content": system_prompt }];

function removeDocumentReferences(str) {
  // Regular expression to match [docX]
  var regex = /\[doc\d+\]/g;

  // Replace document references with an empty string
  var result = str.replace(regex, '');

  return result;
}

// Setup WebRTC
function setupWebRTC() {
  // Create WebRTC peer connection
  fetch("/api/getIceServerToken", {
    method: "POST"
  })
    .then(async res => {
      const reponseJson = await res.json()
      peerConnection = new RTCPeerConnection({
        iceServers: [{
          urls: reponseJson["Urls"],
          username: reponseJson["Username"],
          credential: reponseJson["Password"]
        }]
      })

      // Fetch WebRTC video stream and mount it to an HTML video element
      peerConnection.ontrack = function (event) {
        console.log('peerconnection.ontrack', event)
        // Clean up existing video element if there is any
        remoteVideoDiv = document.getElementById('remoteVideo')
        for (var i = 0; i < remoteVideoDiv.childNodes.length; i++) {
          if (remoteVideoDiv.childNodes[i].localName === event.track.kind) {
            remoteVideoDiv.removeChild(remoteVideoDiv.childNodes[i])
          }
        }

        const videoElement = document.createElement(event.track.kind)
        videoElement.id = event.track.kind
        videoElement.srcObject = event.streams[0]
        videoElement.autoplay = true
        videoElement.controls = false
        document.getElementById('remoteVideo').appendChild(videoElement)

        canvas = document.getElementById('canvas')
        remoteVideoDiv.hidden = true
        canvas.hidden = false

        videoElement.addEventListener('play', () => {
          remoteVideoDiv.style.width = videoElement.videoWidth / 2 + 'px'
          window.requestAnimationFrame(makeBackgroundTransparent)
        })
      }

      // Make necessary update to the web page when the connection state changes
      peerConnection.oniceconnectionstatechange = e => {
        console.log("WebRTC status: " + peerConnection.iceConnectionState)
      }

      // Offer to receive 1 audio, and 1 video track
      peerConnection.addTransceiver('video', { direction: 'sendrecv' })
      peerConnection.addTransceiver('audio', { direction: 'sendrecv' })

      // start avatar, establish WebRTC connection
      avatarSynthesizer.startAvatarAsync(peerConnection).then((r) => {
        if (r.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
          console.log("[" + (new Date()).toISOString() + "] Avatar started. Result ID: " + r.resultId)
          greeting()
        } else {
          console.log("[" + (new Date()).toISOString() + "] Unable to start avatar. Result ID: " + r.resultId)
          if (r.reason === SpeechSDK.ResultReason.Canceled) {
            let cancellationDetails = SpeechSDK.CancellationDetails.fromResult(r)
            if (cancellationDetails.reason === SpeechSDK.CancellationReason.Error) {
              console.log(cancellationDetails.errorDetails)
            };

            console.log("Unable to start avatar: " + cancellationDetails.errorDetails);
          }
        }
      }).catch(
        (error) => {
          console.log("[" + (new Date()).toISOString() + "] Avatar failed to start. Error: " + error)
          document.getElementById('startSession').disabled = false
          document.getElementById('configuration').hidden = false
        }
      )

    })
}

async function generateText(prompt) {

  messages.push({
    role: 'user',
    content: prompt
  });

  let generatedText
  let products
  await fetch(`/api/message`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(messages) })
    .then(response => response.json())
    .then(data => {
      generatedText = data["messages"][data["messages"].length - 1].content;
      messages = data["messages"];
      products = data["products"]
    });

  addToConversationHistory(generatedText, 'light');
  if (products.length > 0) {
    addProductToChatHistory(products[0]);
  }
  return generatedText;
}

// Connect to TTS Avatar API
function connectToAvatarService() {
  // Construct TTS Avatar service request
  let videoCropTopLeftX = 600
  let videoCropBottomRightX = 1320
  let backgroundColor = '#00FF00FF'

  const videoFormat = new SpeechSDK.AvatarVideoFormat()
  videoFormat.setCropRange(new SpeechSDK.Coordinate(videoCropTopLeftX, 0), new SpeechSDK.Coordinate(videoCropBottomRightX, 1080));

  const avatarConfig = new SpeechSDK.AvatarConfig(TalkingAvatarCharacter, TalkingAvatarStyle, videoFormat)
  avatarConfig.backgroundColor = backgroundColor

  avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechSynthesisConfig, avatarConfig)
  avatarSynthesizer.avatarEventReceived = function (s, e) {
    var offsetMessage = ", offset from session start: " + e.offset / 10000 + "ms."
    if (e.offset === 0) {
      offsetMessage = ""
    }
    console.log("Event received: " + e.description + offsetMessage)
  }

}

window.startSession = () => {
  speechSynthesisConfig.speechSynthesisVoiceName = TTSVoice

  fetch("/api/getSpeechToken", {
    method: "POST"
  })
    .then(response => response.text())
    .then(response => {
      speechSynthesisConfig.authorizationToken = response;
      token = response
    })
    .then(() => {
      speechSynthesizer = new SpeechSDK.SpeechSynthesizer(speechSynthesisConfig, null)
      connectToAvatarService()
      setupWebRTC()
    })
}

async function greeting() {
  addToConversationHistory("Hola, soy Megan, bienvenidos a esta feria donde podran conocer los proyectos de CT+I en el Instituto Colombiano del petroleo y energias para la transición. Estoy aqui para responder sus preguntas acerca de nuestra estrategia CT+I o cualquiera de nuestros proyectos. ¿Como puedo ayudarte?", "light")

  let spokenText = "<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='https://www.w3.org/2001/mstts' xml:lang='es-CO'><voice xml:lang='es-CO' xml:gender='Female' name='es-CO-SalomeNeural'>【gesture.say-hi】 Hola, soy Megan, bienvenidos a esta feria donde podran conocer los proyectos de CT+I en el Instituto Colombiano del petroleo y energias para la transición. Estoy aqui para responder sus preguntas acerca de nuestra estrategia CT+I o cualquiera de nuestros proyectos. 【gesture.show-front-2】 ¿Como puedo ayudarte?</voice></speak>"
  avatarSynthesizer.speakSsmlAsync(spokenText, (result) => {
    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
      console.log("Speech synthesized to speaker for text [ " + spokenText + " ]. Result ID: " + result.resultId)
    } else {
      console.log("Unable to speak text. Result ID: " + result.resultId)
      if (result.reason === SpeechSDK.ResultReason.Canceled) {
        let cancellationDetails = SpeechSDK.CancellationDetails.fromResult(result)
        console.log(cancellationDetails.reason)
        if (cancellationDetails.reason === SpeechSDK.CancellationReason.Error) {
          console.log(cancellationDetails.errorDetails)
        }
      }
    }
  })
}

window.speak = (text) => {
  async function speak(text) {
    addToConversationHistory(text, 'dark')

    fetch("/api/detectLanguage?text=" + text, {
      method: "POST"
    })
      .then(response => response.text())
      .then(async language => {
        console.log(`Detected language: ${language}`);

        const generatedResult = await generateText(text);

        let spokenTextssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='https://www.w3.org/2001/mstts' xml:lang='en-US'><voice xml:lang='en-US' xml:gender='Female' name='en-US-JennyMultilingualNeural'><lang xml:lang="${language}">${generatedResult}</lang></voice></speak>`

        if (language == 'ar-AE') {
          spokenTextssml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='https://www.w3.org/2001/mstts' xml:lang='en-US'><voice xml:lang='en-US' xml:gender='Female' name='ar-AE-FatimaNeural'><lang xml:lang="${language}">${generatedResult}</lang></voice></speak>`
        }
        let spokenText = generatedResult
        avatarSynthesizer.speakSsmlAsync(spokenTextssml, (result) => {
          if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
            console.log("Speech synthesized to speaker for text [ " + spokenText + " ]. Result ID: " + result.resultId)
          } else {
            console.log("Unable to speak text. Result ID: " + result.resultId)
            if (result.reason === SpeechSDK.ResultReason.Canceled) {
              let cancellationDetails = SpeechSDK.CancellationDetails.fromResult(result)
              console.log(cancellationDetails.reason)
              if (cancellationDetails.reason === SpeechSDK.CancellationReason.Error) {
                console.log(cancellationDetails.errorDetails)
              }
            }
          }
        })
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }
  speak(text);
}

window.stopSession = () => {
  speechSynthesizer.close()
}

window.startRecording = () => {
  const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, 'southcentralus');
  speechConfig.authorizationToken = token;
  speechConfig.SpeechServiceConnection_LanguageIdMode = "Continuous";
  var autoDetectSourceLanguageConfig = SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(supported_languages);
  // var autoDetectSourceLanguageConfig = SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(["en-US"]);

  document.getElementById('buttonIcon').className = "fas fa-stop"
  document.getElementById('startRecording').disabled = true

  recognizer = SpeechSDK.SpeechRecognizer.FromConfig(speechConfig, autoDetectSourceLanguageConfig);

  recognizer.recognized = function (s, e) {
    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
      console.log('Recognized:', e.result.text);
      window.stopRecording();
      // TODO: append to conversation
      window.speak(e.result.text);
    }
  };

  recognizer.startContinuousRecognitionAsync();

  console.log('Recording started.');
}

window.stopRecording = () => {
  if (recognizer) {
    recognizer.stopContinuousRecognitionAsync(
      function () {
        recognizer.close();
        recognizer = undefined;
        document.getElementById('buttonIcon').className = "fas fa-microphone"
        document.getElementById('startRecording').disabled = false
        console.log('Recording stopped.');
      },
      function (err) {
        console.error('Error stopping recording:', err);
      }
    );
  }
}
window.onload = function() {
  window.startSession();
};

window.submitText = () => {
  document.getElementById('spokenText').textContent = document.getElementById('textinput').currentValue
  document.getElementById('textinput').currentValue = ""
  window.speak(document.getElementById('textinput').currentValue);
}
function addToConversationHistory(item, historytype) {
  const list = document.getElementById('chathistory');
  const newItem = document.createElement('li');
  newItem.classList.add('message');
  newItem.classList.add(`message--${historytype}`);
  newItem.textContent = item;
  list.appendChild(newItem);
}

function addProductToChatHistory(product) {
  const list = document.getElementById('chathistory');
  const listItem = document.createElement('li');
  listItem.classList.add('product');
  listItem.innerHTML = `
    <fluent-card class="product-card">
      <div class="product-card__header">
        <img src="${product.image_url}" alt="tent" width="100%">
      </div>
      <div class="product-card__content">
        <div><span class="product-card__price">$${product.special_offer}</span> <span class="product-card__old-price">$${product.original_price}</span></div>
        <div>${product.tagline}</div>
      </div>
    </fluent-card>
  `;
  list.appendChild(listItem);
}

// Make video background transparent by matting
function makeBackgroundTransparent(timestamp) {
  // Throttle the frame rate to 30 FPS to reduce CPU usage
  if (timestamp - previousAnimationFrameTimestamp > 30) {
    video = document.getElementById('video')
    tmpCanvas = document.getElementById('tmpCanvas')
    tmpCanvasContext = tmpCanvas.getContext('2d', { willReadFrequently: true })
    tmpCanvasContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight)
    if (video.videoWidth > 0) {
      let frame = tmpCanvasContext.getImageData(0, 0, video.videoWidth, video.videoHeight)
      for (let i = 0; i < frame.data.length / 4; i++) {
        let r = frame.data[i * 4 + 0]
        let g = frame.data[i * 4 + 1]
        let b = frame.data[i * 4 + 2]

        if (g - 150 > r + b) {
          // Set alpha to 0 for pixels that are close to green
          frame.data[i * 4 + 3] = 0
        } else if (g + g > r + b) {
          // Reduce green part of the green pixels to avoid green edge issue
          adjustment = (g - (r + b) / 2) / 3
          r += adjustment
          g -= adjustment * 2
          b += adjustment
          frame.data[i * 4 + 0] = r
          frame.data[i * 4 + 1] = g
          frame.data[i * 4 + 2] = b
          // Reduce alpha part for green pixels to make the edge smoother
          a = Math.max(0, 255 - adjustment * 4)
          frame.data[i * 4 + 3] = a
        }
      }

      canvas = document.getElementById('canvas')
      canvasContext = canvas.getContext('2d')
      canvasContext.putImageData(frame, 0, 0);
    }

    previousAnimationFrameTimestamp = timestamp
  }

  window.requestAnimationFrame(makeBackgroundTransparent)
}
